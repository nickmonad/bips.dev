<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="Read BIPs like a pro." />
    <meta name="keywords" content="bitcoin, bitcoin improvement proposals, bip, bips, static, share" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta property="og:title" content="BIP 346: OP_TXHASH" />
    <meta property="og:description" content="Read BIPs like a pro." />
    <meta property="og:image" content="https://bips.dev/og-bips-dev.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="BIP 346: OP_TXHASH" />
    <meta name="twitter:description" content="Read BIPs like a pro." />
    <meta name="twitter:creator" content="@nickmonad" />
    <meta name="twitter:image" content="https://bips.dev/og-bips-dev.png" />

    <title>BIP 346: OP_TXHASH</title>

    
        <link rel="stylesheet" href="/style.css" />
    

    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
    <script src="/pagefind/pagefind-ui.js"></script>

    <script defer data-domain="bips.dev" src="/js/script.js"></script>
    <script>
        // setup plausible function for custom events
        window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }

        // setup and initialize dark mode
        // https://tailwindcss.com/docs/dark-mode
        window.setTheme = function() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark')
            } else {
                document.documentElement.classList.remove('dark')
            }
        }
        window.setTheme();

        // searching via
        // https://pagefind.app
        window.addEventListener('DOMContentLoaded', function(event) {
            new PagefindUI({
                element: "#search",
                hightlightParam: "highlight",
                showImages: false,
                showSubResults: true,
                translations: {
                    placeholder: "Search BIPs"
                },
                processTerm: function(term) {
                    plausible('Search');
                    return term;
                }
            });
        });
    </script>

    <style>
        /* variables to override on pagefind */
        /* https://pagefind.app/docs/ui-usage/#customising-the-styles */
        /* values are from tailwind: https://tailwindcss.com/docs/customizing-colors */
        :root {
            --pagefind-ui-primary: #334155;
            --pagefind-ui-text: #334155;
            --pagefind-ui-background: #ffffff;
            --pagefind-ui-border-width: 1px;
            --pagefind-ui-border-radius: 4px;
        }

        html.dark {
            --pagefind-ui-primary: #d1d5db;
            --pagefind-ui-text: #d1d5db;
            --pagefind-ui-background: #18181b;
            --pagefind-ui-border: #152028;
        }

        mark {
            background-color: #ff9900 !important;
            color: #6b7280 !important;
        }
    </style>
</head>

<body class="bg-white dark:bg-zinc-900">
    <div class="container mx-auto flex justify-center">
        <div data-pagefind-body class="min-w-full max-w-full lg:min-w-[1000px] lg:max-w-[1000px] px-6 py-10 space-y-10 text-slate-700 dark:text-gray-300">
            
    <div class="flex flex-col space-y-4 pt-4 md:pt-8">
        <div class="flex justify-between">
            <a href="/">Back to BIPs</a>
            <div class="flex">
                <svg id="toggleDark_light" class="hidden dark:flex w-6 h-6 hover:cursor-pointer" onclick="localStorage.theme = 'light'; window.setTheme()"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                </svg>
                <svg id="toggleDark_dark" class="flex dark:hidden w-6 h-6 hover:cursor-pointer" onclick="localStorage.theme = 'dark'; window.setTheme()"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                </svg>
            </div>
        </div>
        <div class="flex flex-col space-y-2">
            <div data-pagefind-weight="10" class="text-2xl font-extrabold">BIP 346: OP_TXHASH</div>
            <div class="flex justify-between">
                <div class="text-xl font-semibold">2024-04-24</div>
                <a href="https:&#x2F;&#x2F;github.com&#x2F;bitcoin&#x2F;bips&#x2F;blob&#x2F;master&#x2F;bip-0346.md" target="_blank">View on GitHub</a>
            </div>
        </div>

        <article class="max-w-none prose prose-lg prose-zinc prose-p:leading-relaxed prose-a:font-bold prose-a:underline prose-a:decoration-2 prose-a:decoration-bitcoin prose-pre:bg-zinc-200 prose-pre:text-zinc-800 dark:prose-invert dark:prose-pre:bg-zinc-600 dark:prose-pre:text-white">
            <pre><code>  BIP: 346
  Layer: Consensus (soft fork)
  Title: OP_TXHASH
  Authors: Steven Roose &lt;steven@roose.io&gt;
           Brandon Black &lt;freedom@reardencode.com&gt;
  Status: Draft
  Type: Specification
  Assigned: 2024-04-24
  License: BSD-3-Clause
</code></pre>
<h1 id="Abstract">Abstract</h1>
<p>This BIP proposes a new opcode <code>OP_TXHASH</code>, to be activated as a change to the
semantics of <code>OP_SUCCESS189</code> in tapscript contexts.</p>
<p>This opcode provides a generalized method for introspecting certain details of
the spending transaction, which enables non-interactive enforcement of certain
properties of the transaction spending a certain UTXO.</p>
<p>Together with an opcode like <code>OP_CHECKSIGFROMSTACK</code>, this opcode effectively
provides a fully generalized signature hash construction, fully supporting
all existing SIGHASH flags, the proposed sighash flags from
<a href="https://bips.dev/346/bip-0118.mediawiki">BIP-118</a> (<code>SIGHASH_ANYPREVOUT</code>) and many other new signature hash
combinations.</p>
<p>The constructions specified in this BIP also open up the way for other
potential updates; see Motivation section for more details.</p>
<h1 id="Specification">Specification</h1>
<h2 id="OP_TXHASH">OP_TXHASH</h2>
<p><code>OP_TXHASH</code> redefines the <code>OP_SUCCESS189</code> tapscript opcode (<code>0xbd</code>) as a soft
fork upgrade. This opcode is only active in tapscript contexts.</p>
<p>Note that <code>OP_SUCCESS187</code> is used by <a href="https://bips.dev/346/bip-0443.mediawiki">BIP-443</a> (<code>OP_CHECKCONTRACTVERIFY</code>) and
<code>OP_SUCCESS188</code> was used by <a href="https://bips.dev/346/bip-0345.mediawiki">BIP-345</a> (<code>OP_VAULT</code>) at the time of first draft
of this BIP, making <code>OP_SUCCESS189</code> the next available opcode for this purpose.</p>
<p>It has the following semantics:</p>
<ul>
<li>There is at least one element on the stack, fail otherwise.</li>
<li>The element is interpreted as the TxFieldSelector and is popped off the stack.</li>
<li>The TxFieldSelector must be valid, fail otherwise.</li>
<li>The 32-byte TxHash of the transaction at the current input index, calculated
using the given TxFieldSelector is pushed onto the stack.</li>
</ul>
<h2 id="TxFieldSelector">TxFieldSelector</h2>
<p>The TxFieldSelector has the following encoding. We will give a brief conceptual
summary, followed by a reference implementation of the CalculateTxHash function.</p>
<p>In the following specifications, the <code>|</code> operator is used for the bitwise OR
operation.</p>
<ul>
<li>There are two special cases for the TxFieldSelector:
<ul>
<li>
<p>the empty value, zero bytes long: it is set equal to <code>TXFS_SPECIAL_TEMPLATE</code>,
the de-facto default value which means everything except the prevouts and
the prevout scriptPubkeys and amounts.</p>
<p>Special case <code>TXFS_SPECIAL_TEMPLATE</code> is 4 bytes long, as follows:</p>
<ul>
<li>1: <code>TXFS_VERSION | TXFS_LOCKTIME | TXFS_CURRENT_INPUT_IDX</code></li>
<li>2: <code>TXFS_INPUTS_SEQUENCES | TXFS_INPUTS_SCRIPTSIGS | TXFS_OUTPUTS_ALL</code></li>
<li>3: <code>TXFS_INOUT_NUMBER | TXFS_INOUT_SELECTION_ALL</code></li>
<li>4: <code>TXFS_INOUT_NUMBER | TXFS_INOUT_SELECTION_ALL</code></li>
</ul>
</li>
<li>
<p>If the TxFieldSelector has exactly 1 byte, we use a <em>short notation</em>.
It has its 8 bits assigned as follows, from lowest to highest:</p>
<ul>
<li>2/1: Inputs
<ul>
<li>00: <code>TXFS_INOUT_SELECTION_NONE</code></li>
<li>01: <code>TXFS_INOUT_SELECTION_CURRENT</code></li>
<li>11: <code>TXFS_INOUT_SELECTION_ALL</code></li>
</ul>
</li>
<li>4/3: Outputs
<ul>
<li>00: <code>TXFS_INOUT_SELECTION_NONE</code></li>
<li>01: <code>TXFS_INOUT_SELECTION_CURRENT</code></li>
<li>11: <code>TXFS_INOUT_SELECTION_ALL</code></li>
</ul>
</li>
<li>5: <code>TXFS_INPUTS_PREVOUTS</code></li>
<li>6: <code>TXFS_INPUTS_PREV_SCRIPTPUBKEYS | TXFS_INPUTS_PREV_VALUES</code></li>
<li>7: <code>TXFS_CURRENT_INPUT_CONTROL_BLOCK | TXFS_CURRENT_INPUT_SPENTSCRIPT | TXFS_CURRENT_INPUT_LAST_CODESEPARATOR_POS</code></li>
<li>8: <code>TXFS_CURRENT_INPUT_IDX</code></li>
</ul>
<p>Additionally, it includes <code>TXFS_VERSION | TXFS_LOCKTIME | TXFS_CONTROL | TXFS_CURRENT_INPUT_TAPROOT_ANNEX</code>
as global fields and <code>TXFS_INPUTS_SEQUENCES | TXFS_INPUTS_SCRIPTSIGS | TXFS_OUTPUTS_ALL</code>
as input and output fields.</p>
<p>These 1-byte selections allow the TxFieldSelector to emulate current
signature hashing modes and those defined in <a href="https://bips.dev/346/bip-0118.mediawiki">BIP-118</a>:</p>
</li>
</ul>
</li>
</ul>
<table><thead><tr><th style="text-align: left">BIP-341/118 sighash type</th><th style="text-align: left">1-byte TxFieldSelector</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>ALL</code></td><td style="text-align: left"><code>0b11111111</code></td></tr>
<tr><td style="text-align: left"><code>SINGLE</code></td><td style="text-align: left"><code>0b11110111</code></td></tr>
<tr><td style="text-align: left"><code>NONE</code></td><td style="text-align: left"><code>0b11110011</code></td></tr>
<tr><td style="text-align: left"><code>ALL\|ANYONECANPAY</code></td><td style="text-align: left"><code>0b11111101</code></td></tr>
<tr><td style="text-align: left"><code>SINGLE\|ANYONECANPAY</code></td><td style="text-align: left"><code>0b11110101</code></td></tr>
<tr><td style="text-align: left"><code>NONE\|ANYONECANPAY</code></td><td style="text-align: left"><code>0b11110001</code></td></tr>
<tr><td style="text-align: left"><code>ALL\|ANYPREVOUT</code></td><td style="text-align: left"><code>0b11101101</code></td></tr>
<tr><td style="text-align: left"><code>SINGLE\|ANYPREVOUT</code></td><td style="text-align: left"><code>0b11100101</code></td></tr>
<tr><td style="text-align: left"><code>NONE\|ANYPREVOUT</code></td><td style="text-align: left"><code>0b11100001</code></td></tr>
<tr><td style="text-align: left"><code>ALL\|ANYPREVOUTANYSCRIPT</code></td><td style="text-align: left"><code>0b11001101</code></td></tr>
<tr><td style="text-align: left"><code>SINGLE\|ANYPREVOUTANYSCRIPT</code></td><td style="text-align: left"><code>0b11000101</code></td></tr>
<tr><td style="text-align: left"><code>NONE\|ANYPREVOUTANYSCRIPT</code></td><td style="text-align: left"><code>0b11000001</code></td></tr>
</tbody></table>
<ul>
<li>
<p>If the TxFieldSelector is longer than one byte, the first byte of the TxFieldSelector
has its 8 bits assigned as follows, from lowest to highest:</p>
<ul>
<li>1: version (<code>TXFS_VERSION</code>)</li>
<li>2: locktime (<code>TXFS_LOCKTIME</code>)</li>
<li>3: current input index (<code>TXFS_CURRENT_INPUT_IDX</code>)</li>
<li>4: current input control block (<code>TXFS_CURRENT_INPUT_CONTROL_BLOCK</code>)</li>
<li>5: current input spent script (<code>TXFS_CURRENT_INPUT_SPENTSCRIPT</code>)</li>
<li>6: current script last <code>OP_CODESEPARATOR</code> position (or 0xffffffff)
(<code>TXFS_CURRENT_INPUT_LAST_CODESEPARATOR_POS</code>)</li>
<li>7: current input annex including prefix byte (or empty) (<code>TXFS_CURRENT_INPUT_TAPROOT_ANNEX</code>)</li>
<li>8: <code>TXFS_CONTROL</code> (i.e. include TxFieldSelector into hash)</li>
</ul>
</li>
<li>
<p>The highest bit of the first byte (<code>TXFS_CONTROL</code>), we will call the
&quot;control bit&quot;, and it can be used to control the behavior of the opcode. For
<code>OP_TXHASH</code>, the control bit is used to determine
whether the TxFieldSelector itself has to be included in the resulting hash.
(For potential other uses of the TxFieldSelector (like a hypothetical
<code>OP_TX</code>), this bit can be repurposed.)</p>
</li>
<li>
<p>The second byte will be used to indicate fields from the inputs and outputs.
The 8 bits are assigned the following variables, from lowest to highest:</p>
<ul>
<li>
<p>Specifying which fields of the inputs will be selected:</p>
<ul>
<li>1: prevouts (<code>TXFS_INPUTS_PREVOUTS</code>)</li>
<li>2: sequences (<code>TXFS_INPUTS_SEQUENCES</code>)</li>
<li>3: scriptSigs (<code>TXFS_INPUTS_SCRIPTSIGS</code>)</li>
<li>4: prevout scriptPubkeys (<code>TXFS_INPUTS_PREV_SCRIPTPUBKEYS</code>)</li>
<li>5: prevout values (<code>TXFS_INPUTS_PREV_VALUES</code>)</li>
<li>6: taproot annexes (<code>TXFS_INPUTS_TAPROOT_ANNEXES</code>)</li>
</ul>
</li>
<li>
<p>Specifying which fields of the outputs will be selected:</p>
<ul>
<li>7: scriptPubkeys (<code>TXFS_OUTPUTS_SCRIPTPUBKEYS</code>)</li>
<li>8: values (<code>TXFS_OUTPUTS_VALUES</code>)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>We define as follows:</p>
<ul>
<li><code>TXFS_ALL = TXFS_VERSION | TXFS_LOCKTIME | TXFS_CURRENT_INPUT_IDX | TXFS_CURRENT_INPUT_CONTROL_BLOCK | TXFS_CURRENT_INPUT_LAST_CODESEPARATOR_POS | TXFS_CONTROL</code></li>
<li><code>TXFS_INPUTS_ALL = TXFS_INPUTS_PREVOUTS | TXFS_INPUTS_SEQUENCES | TXFS_INPUTS_SCRIPTSIGS | TXFS_INPUTS_PREV_SCRIPTPUBKEYS | TXFS_INPUTS_PREV_VALUES | TXFS_INPUTS_TAPROOT_ANNEXES</code></li>
<li><code>TXFS_OUTPUTS_ALL = TXFS_OUTPUTS_SCRIPTPUBKEYS | TXFS_OUTPUTS_VALUES</code></li>
</ul>
</li>
<li>
<p>For both inputs and then outputs, expect an additional byte as follows:</p>
<ul>
<li>
<p>The highest bit (<code>TXFS_INOUT_NUMBER</code>) indicates whether the &quot;number of
in-/outputs&quot; should be committed to.</p>
</li>
<li>
<p>For the remaining bits, there are three exceptional values:</p>
<ul>
<li>0x00 (<code>TXFS_INOUT_SELECTION_NONE</code>) means &quot;no in/outputs&quot; (hence only the
number of them as <code>0x80</code> (<code>TXFS_INOUT_NUMBER</code>)).</li>
<li><code>0x40</code> (<code>TXFS_INOUT_SELECTION_CURRENT</code>) means &quot;select only the in/output
of the current input index&quot; (it is invalid when current index exceeds
number of outputs).</li>
<li><code>0x3f</code> (<code>TXFS_INOUT_SELECTION_ALL</code>) means &quot;select all in/outputs&quot;.</li>
</ul>
</li>
<li>
<p>The second highest bit (<code>TXFS_INOUT_SELECTION_MODE</code>) is the &quot;specification mode&quot;:</p>
<ul>
<li>Set to 0 it means &quot;leading mode&quot;.</li>
<li>Set to 1 it means &quot;individual mode&quot;.</li>
</ul>
</li>
<li>
<p>In &quot;leading mode&quot;, the third highest bit (<code>TXFS_INOUT_LEADING_SIZE</code>) is
used to indicate the &quot;index size&quot;, i.e. the number of bytes will be used to
represent the number of in/output.</p>
<ul>
<li>With &quot;index size&quot; set to 0, the remaining lowest 5 bits of the first byte
will be interpreted as the number of leading in/outputs to select.</li>
<li>With &quot;index size&quot; set to 1, the remaining lowest 5 bits of the first byte
together with the 8 bits of the next byte will be interpreted as the
number of leading in/outputs to select.</li>
</ul>
</li>
<li>
<p>In &quot;individual mode&quot;, the third highest bit (<code>TXFS_INOUT_INDIVIDUAL_MODE</code>)
indicates whether we are passing absolute indices (0) or indices relative
to the current input (1), the remaining lowest 5 bits will be interpreted
as <code>n</code>, the number of individual in/outputs follow.</p>
<ul>
<li>In absolute mode (second highest bit is 0), for each of the <code>n</code> indices,
at least one extra byte is expected.
<ul>
<li>If that byte's highest bit is set to 0, the remaining 7 bits represent
the absolute index to select.</li>
<li>If that byte's highest bit is set to 1, the remaining 7 bits, together
with the next byte's 8 bits represent the absolute index to select.</li>
</ul>
</li>
<li>In relative mode (second highest bit is 1), for each of the <code>n</code> indices,
at least one extra byte is expected.
<ul>
<li>If that byte's highest bit is set to 0, the remaining 7 bits represent
the relative index in two's complement.</li>
<li>If that byte's highest bit is set to 1, the remaining 7 bits, together
with the next byte's 8 bits represent the relative index in two's
complement.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Effectively, this allows a user to select</p>
<ul>
<li>all in/outputs</li>
<li>the current input index</li>
<li>the leading in/outputs up to 8,191</li>
<li>up to 32 individually selected in/outputs
** using absolute indices up to 32,767
** using indices relative to the current input index from -16382 to +16383.</li>
</ul>
<h3 id="TxFieldSelector_malleability">TxFieldSelector malleability</h3>
<p>It is possible to represent the same selected data using multiple different
TxFieldSelectors. For this reason, users are advised to always set the
<code>TXFS_CONTROL</code> field flag that commits to the TxFieldSelector that was used
to get the hash.</p>
<h3 id="Visualization">Visualization</h3>
<ul>
<li>first byte</li>
</ul>
<pre><code>1 1 1 1 1 1 1 1
| | | | | | | ^ version
| | | | | | ^ locktime
| | | | | ^ current input index
| | | | ^ current input control block
| | | ^ current input spent script
| | ^ current script last OP_CODESEPARATOR
| ^ current input taproot annex
^ control bit (ie. include TXFS in hash)
</code></pre>
<ul>
<li>second byte</li>
</ul>
<pre><code>&lt;-&gt; outputs
| | &lt;---------&gt; inputs
1 1 1 1 1 1 1 1
| | | | | | | ^ prevouts
| | | | | | ^ sequences
| | | | | ^ scriptSigs
| | | | ^ prevout scriptPubkeys
| | | ^ prevout values
| | ^ taproot annexes
| ^ scriptPubkeys
^ values
</code></pre>
<ul>
<li>in/output selector byte</li>
</ul>
<p>&quot;leading 3 in/outputs&quot;</p>
<pre><code>1 0 0 0 0 0 1 1
| | | &lt;-------&gt; integer 0b00011 == 3
| | ^ index size: single byte
| ^ leading mode
^ commit the number of in&#x2F;outputs
</code></pre>
<p>&quot;leading 257 in/outputs&quot;</p>
<pre><code>1 0 1 0 0 0 0 1  0 0 0 0 0 0 0 1
| | | &lt;------------------------&gt; integer 0b00001 00000001 == 257
| | ^ index size 1: two bytes
| ^ leading mode
^ commit the number of in&#x2F;outputs
</code></pre>
<p>&quot;indices 1 and 3&quot;</p>
<pre><code>0 1 0 0 0 0 1 0  0 0 0 0 0 0 0 1  0 0 0 0 0 0 1 1
| | | |                           &lt;--------------&gt; second idx: 3
| | | |          &lt;-------------&gt; first idx: 1
| | | | &lt;-----&gt; selection count: 0b0010 == 2 indices
| | | ^ index size: single byte per index
| | ^ absolute index
| ^ individual mode
^ don&#x27;t commit the number of in&#x2F;outputs
</code></pre>
<ul>
<li>total example</li>
</ul>
<pre><code>ff ff c2 01 03 83
 |  |           ^ commit number of outputs + leading 3 outputs
 |  | &lt;------&gt; commit number of inputs + inputs at indices 1 and 3
 |  ^ all input and output fields
 ^ all regular fields
</code></pre>
<h2 id="Resource_limits">Resource limits</h2>
<p>Using the same validation budget (&quot;sigops budget&quot;) introduced in BIP-0342,
each TransactionHash decreases the validation budget by 25. If this brings the
budget below zero, the script fails immediately.<br>The following
considerations should be made:</p>
<ul>
<li>All fields that can be of arbitrary size are cacheable as TransactionHash
always hashes their hashed values.</li>
<li>In &quot;individual mode&quot;, a user can at most commit 32 inputs or outputs,
which we don't consider excessive for potential repeated use.</li>
<li>In &quot;leading mode&quot;, a caching strategy can be used where the SHA256 context
is stored every N in/outputs so that multiple executions of the
TransactionHash function can use the caches and only have to hash an
additional N-1 items at most.</li>
</ul>
<h1 id="Motivation">Motivation</h1>
<p>This BIP specifies a basic transaction introspection primitive that is useful
to either reduce interactivity in multi-user protocols or to enforce some basic
constraints on transactions.</p>
<p>Additionally, the constructions specified in this BIP can lay the groundwork for
some potential future upgrades:</p>
<ul>
<li>The TxFieldSelector construction would work well with a hypothetical opcode
<code>OP_TX</code> that allows for directly introspecting the transaction by putting the
fields selected on the stack instead of hashing them together.</li>
<li>The TransactionHash obtained by <code>OP_TXHASH</code> can be combined with <code>OP_CHECKSIGFROMSTACK</code>
(see <a href="https://bips.dev/346/bip-0348.md">BIP-348</a>) to effectively create an
incredibly flexible signature hash, which would enable constructions like
<code>SIGHASH_ANYPREVOUT</code>.</li>
<li>The TransactionHash obtained by <code>OP_TXHASH</code> can be introduced as a native
sighash calculation in a future segwit upgrade, so that signatures using the
TransactionHash as their sighash can be used in keyspend context.</li>
</ul>
<h2 id="Comparing_with_some_alternative_proposals">Comparing with some alternative proposals</h2>
<ul>
<li>
<p>This proposal strictly generalizes BIP-119's <code>OP_CHECKTEMPLATEVERIFY</code>, as the
default mode of our TxFieldSelector is semantically the same (though not
byte-for-byte identical) as what <code>OP_CTV</code> accomplishes, without costing any
additional bytes. Additionally, using <code>OP_TXHASH</code> allows for more
flexibility which can help in the case for</p>
<ul>
<li>enabling adding fees to a transaction without breaking a multi-tx protocol;</li>
<li>multi-user protocols where users are only concerned about their own inputs and outputs.</li>
</ul>
</li>
<li>
<p>Constructions like <code>OP_IN_OUT_VALUE</code> used with <code>OP_EQUALVERIFY</code> can be
emulated by two <code>OP_TXHASH</code> instances by using the TxFieldSelector to select
a single input value first and a single output value second and enforcing
equality on the hashes. Neither of these alternatives can be used to enforce
small value differences without the availability of 64-bit arithmetic in
Script.</p>
</li>
<li>
<p>Like mentioned above, <code>SIGHASH_ANYPREVOUT</code> can be emulated using <code>OP_TXHASH</code>
when combined with <code>OP_CHECKSIGFROMSTACK</code>: 
<code>&lt;txfs&gt; OP_TXHASH &lt;pubkey&gt; OP_CHECKSIGFROMSTACK</code> effectively emulates <code>SIGHASH_ANYPREVOUT</code>.</p>
</li>
</ul>
<h1 id="Reference_Implementation">Reference Implementation</h1>
<p>A reference implementation in Rust is provided attached as part of this BIP
together with a JSON file of test vectors generated using the reference
implementation.</p>
<h1 id="Design_Considerations">Design Considerations</h1>
<p>This specification in in <em>Draft</em> and there is definitely still room for feedback
and improvements. Some considerations that were made but could be revisited:</p>
<ul>
<li>The <code>0b10</code> in/output selector for the shorthand is unused.
Could possibly be filled in with &quot;current + next&quot;, &quot;current + previous&quot; or
any other semantics.</li>
<li>The individual index selection semantics allow for absolute indices up to ~32k
and relative ones up to +/- ~16k, which is probably excessive. When removing
the second byte there would reduce that to just 256 and +/- 128 respectively.</li>
<li>Similar to <code>OP_TEMPLATEHASH</code> (BIP number to be assigned, <a rel="noopener" target="_blank" href="https://github.com/bitcoin/bips/pull/1974">PR</a>),
we could not support <code>scriptSigs</code> anymore and remove
<code>TXFS_INPUTS_SCRIPTSIGS</code>. This field could then possibly be repurposed.</li>
</ul>
<h1 id="Backwards_Compatibility">Backwards Compatibility</h1>
<p><code>OP_TXHASH</code> replaces <code>OP_SUCCESS189</code>. The <code>SUCCESS</code> opcodes were
introduced in taproot (BIP-342) to support changing the semantics of opcodes in
ways that do allow the new semantics to change the stack. For this reason,
<code>OP_TXHASH</code> only works in tapscript context. Since it is overriding a <code>SUCCESS</code>
opcode, any older version of the software will always accept any script that
uses the opcode, while the new versions of the software will validate the
scripts according to the semantics outlined in this BIP. As such, this is also a
soft fork change.</p>
<h2 id="Interactions_with_other_BIPs">Interactions with other BIPs</h2>
<p>This proposal interacts with several other BIPs:</p>
<ul>
<li>
<p><strong><a href="https://bips.dev/346/bip-0118.mediawiki">BIP-118</a> (SIGHASH_ANYPREVOUT)</strong>: <code>OP_TXHASH</code> can be combined with
<code>OP_CHECKSIGFROMSTACK</code> (BIP-348) to emulate <code>SIGHASH_ANYPREVOUT</code> and other
signature hash modes defined in BIP-118. The 1-byte TxFieldSelector format
explicitly supports these modes.</p>
</li>
<li>
<p><strong><a href="https://bips.dev/346/bip-0119.mediawiki">BIP-119</a> (OP_CHECKTEMPLATEVERIFY)</strong>: <code>OP_TXHASH</code> with the empty
TxFieldSelector produces a hash semantically equivalent to BIP-119's
<code>OP_CHECKTEMPLATEVERIFY</code>, making this proposal a generalization of BIP-119.</p>
</li>
<li>
<p><strong><a href="https://bips.dev/346/bip-0347.mediawiki">BIP-347</a> (OP_CAT)</strong>: When combined with <code>OP_CAT</code>, <code>OP_TXHASH</code> enables
powerful transaction introspection capabilities. The bit encoding format is
designed to be explicit about endianness to ensure correct interaction with
concatenation operations.</p>
</li>
<li>
<p><strong><a href="https://bips.dev/346/bip-0348.md">BIP-348</a> (OP_CHECKSIGFROMSTACK)</strong>: Together with <code>OP_CHECKSIGFROMSTACK</code>,
<code>OP_TXHASH</code> provides a fully generalized signature hash construction,
enabling flexible covenant designs and multi-user protocols.</p>
</li>
</ul>
<h1 id="Implementation">Implementation</h1>
<p>A reference implementation is included as part of the BIP, see
<a href="https://bips.dev/346/./bip-0346/ref-impl/src/main.rs">here</a>. This implementation focusses on clarity
and correctness, not on efficiency. A rudimentary set of test vectors is also
generated from this implementation and included
<a href="https://bips.dev/346/./bip-0346/ref-impl/txhash_vectors.json">here</a>.</p>
<p>Furthermore, following other implementation attempts exist:</p>
<ul>
<li>A proposed implementation for Bitcoin Core is available here:
https://github.com/bitcoin/bitcoin/pull/29050</li>
<li>A proposed implementation for rust-bitcoin is available here:
https://github.com/rust-bitcoin/rust-bitcoin/pull/2275</li>
</ul>
<p>NOTE: These implementations are slightly outdated as they were made for an
earlier version of this specification. Updates are in progress.</p>
<p>Both of the above implementations perform effective caching to avoid potential
denial-of-service attack vectors.</p>
<h1 id="Deployment">Deployment</h1>
<p>This BIP can be deployed using a BIP 9 VersionBits deployment. The specific
strategy and bit assignment are left unspecified and can later be amended to the
BIP depending on community preference.</p>
<h1 id="Acknowledgement">Acknowledgement</h1>
<p>Credit for this proposal mostly goes to Jeremy Rubin for his work on BIP-119's
<code>OP_CHECKTEMPLATEVERIFY</code> and to Russell O'Connor for the original idea of
generalizing <code>OP_CHECKTEMPLATEVERIFY</code> into <code>OP_TXHASH</code>.</p>
<p>Additional thanks to Andrew Poelstra, Greg Sanders, Rearden Code, Rusty Russell
and others for their feedback on the specification.</p>
<h1 id="Copyright">Copyright</h1>
<p>This document is licensed under the 3-clause BSD license.</p>

        </article>
    </div>


            <hr class="border-slate-700" />

            <div data-pagefind-ignore class="w-full flex flex-col items-center space-y-2 text-center">
                <div class="flex items-center space-x-2">
                    <p class="font-bold">Updated</p>
                    <p class="font-bold">2026-02-07</p>
                </div>
                <p>See an issue with rendering or formatting? Submit an issue on <a href="https://github.com/nickmonad/bips.dev" target="_blank">GitHub</a></p>
                <p>Do you find this site useful? Please consider <a href="https://buy.tryspeed.com/plink_live_lyek4a2yW2Sn2wfA" target="_blank">donating</a> some sats to support ongoing development.</p>
                <p><a href="/">bips.dev</a> is presented by <a href="https://nickmonad.blog" target="_blank">nickmonad</a></p>
                <p class="pt-4 text-sm">All content is owned and licensed by the respective author(s). This website makes no claim of ownership.</p>
            </div>
        </div>
    </div>
</body>
</html>
